<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GestiÃ³n de Flota</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d6efd">
    <link rel="manifest"
        href='data:application/manifest+json,{"name":"Gestion Flota","short_name":"Flota","display":"standalone","start_url":".","background_color":"#ffffff","theme_color":"#0d6efd","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/741/741407.png","sizes":"512x512","type":"image/png"}]}'>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/741/741407.png">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš›</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* Light Theme (Default) */
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.05);

            --primary: hsl(220, 90%, 56%);
            --success: hsl(142, 71%, 45%);
            --danger: hsl(354, 70%, 54%);
            --warning: hsl(45, 100%, 51%);
            --info: hsl(190, 90%, 50%);

            --prioridad-baja: hsl(142, 71%, 45%);
            --prioridad-media: hsl(45, 100%, 51%);
            --prioridad-alta: hsl(27, 98%, 54%);
            --prioridad-urgente: hsl(354, 70%, 54%);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-body: #1a1d21;
            --bg-card: #212529;
            --text-main: #f8f9fa;
            --text-muted: #adb5bd;
            --border-color: #343a40;
            --input-bg: #2b3035;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] .card,
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .list-group-item,
        [data-theme="dark"] .navbar,
        [data-theme="dark"] .bg-white {
            background-color: var(--bg-card) !important;
            color: var(--text-main);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] #contenedorCheckboxes .form-check {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-main);
        }

        [data-theme="dark"] .text-dark {
            color: var(--text-main) !important;
        }

        [data-theme="dark"] .table {
            color: var(--text-main);
            --bs-table-color: var(--text-main);
            --bs-table-bg: transparent;
        }

        [data-theme="dark"] .table-light {
            background-color: #2c3034;
            color: var(--text-main);
            --bs-table-bg: #2c3034;
        }

        /* ANIMACIONES */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.4s ease forwards;
        }

        .modal.show .modal-dialog {
            animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* ESTILOS VISUALES */
        .fuera-servicio {
            background-color: #ffe6e6 !important;
            color: #dc3545;
            font-weight: bold;
            text-decoration: line-through;
        }

        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background-color: #343a40;
            color: white;
            z-index: 2;
            border: none;
        }

        tr {
            transition: transform 0.2s ease, background-color 0.2s;
        }

        /* LOGIN ANIMADO */
        /* LOGIN PREMIUM */
        #pantalla-login {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364);
            /* Deep Aurora */
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            position: relative;
            overflow: hidden;
        }

        /* Efecto de partÃ­culas sutiles (pseudo-elemento) */
        #pantalla-login::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
            pointer-events: none;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .card-login {
            width: 90%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.05);
            /* MÃ¡s transparente */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            padding: 3rem !important;
            color: white;
            transition: transform 0.3s ease;
        }

        .login-header h3 {
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
        }

        /* ROLE CARDS */
        .role-card-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .login-role-card {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            text-align: left;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            text-decoration: none;
            color: white;
            position: relative;
            overflow: hidden;
            width: 100%;
            border: none;
            /* Reset button border */
        }

        .login-role-card:hover {
            transform: translateY(-4px) scale(1.02);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .login-role-card:active {
            transform: scale(0.98);
        }

        .icon-wrapper {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        /* Colores especÃ­ficos de iconos */
        .role-reportador .icon-wrapper {
            background: rgba(13, 202, 240, 0.2);
            color: #0dcaf0;
        }

        .role-tecnico .icon-wrapper {
            background: rgba(25, 135, 84, 0.2);
            color: #198754;
        }

        .role-supervisor .icon-wrapper {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .login-role-card:hover .icon-wrapper {
            transform: scale(1.1) rotate(5deg);
        }

        .text-content {
            flex-grow: 1;
        }

        .text-content h5 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .text-content span {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .arrow-icon {
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.5);
        }

        .login-role-card:hover .arrow-icon {
            opacity: 1;
            transform: translateX(0);
        }

        /* ANIMACIONES DE ENTRADA */
        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-enter {
            opacity: 0;
            animation: slideUpFade 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .delay-100 {
            animation-delay: 0.1s;
        }

        .delay-200 {
            animation-delay: 0.2s;
        }

        .delay-300 {
            animation-delay: 0.3s;
        }

        .delay-400 {
            animation-delay: 0.4s;
        }


        /* UI GENERAL */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .navbar-custom {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 15px 0;
            margin-bottom: 30px;
        }

        #contenedorCheckboxes .form-check {
            background-color: #fff;
            border: 1px solid #dee2e6;
            padding: 10px 15px 10px 40px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        #contenedorCheckboxes .form-check:hover {
            border-color: #0d6efd;
            background-color: #f8fbff;
        }

        .form-check-input:checked+.form-check-label {
            color: #0d6efd;
            font-weight: bold;
        }

        #tablaCuerpo:empty::before {
            content: "No hay reportes pendientes";
            display: block;
            text-align: center;
            padding: 20px;
            color: #adb5bd;
            font-style: italic;
            width: 100%;
        }

        /* PRIORIDADES */
        .prioridad-badge {
            font-weight: 600;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .prioridad-baja {
            background-color: var(--prioridad-baja);
            color: white;
        }

        .prioridad-media {
            background-color: var(--prioridad-media);
            color: #2c3e50;
        }

        .prioridad-alta {
            background-color: var(--prioridad-alta);
            color: white;
        }

        .prioridad-urgente {
            background-color: var(--prioridad-urgente);
            color: white;
            animation: pulso 2s infinite;
        }

        @keyframes pulso {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.85;
                transform: scale(1.05);
            }
        }

        tr.fila-urgente {
            border-left: 4px solid var(--prioridad-urgente) !important;
        }

        tr.fila-alta {
            border-left: 4px solid var(--prioridad-alta) !important;
        }

        tr.fila-media {
            border-left: 4px solid var(--prioridad-media) !important;
        }

        tr.fila-baja {
            border-left: 4px solid var(--prioridad-baja) !important;
        }

        /* FILTROS */
        #panelFiltros {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .contador-resultados {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* VALIDACIONES */
        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: var(--danger);
            border-width: 2px;
        }

        .form-control.is-valid,
        .form-select.is-valid {
            border-color: var(--success);
            border-width: 2px;
        }

        .invalid-feedback {
            display: block;
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .valid-feedback {
            display: block;
            color: var(--success);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .shake {
            animation: shake 0.3s;
        }

        /* TIMELINE Y COMENTARIOS */
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 20px;
            border-left: 2px solid #e9ecef;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
        }

        .timeline-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        .chat-container {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            position: relative;
        }

        .chat-bubble.me {
            align-self: flex-end;
            background-color: var(--primary);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .chat-bubble.other {
            align-self: flex-start;
            background-color: white;
            border: 1px solid #dee2e6;
            border-bottom-left-radius: 2px;
        }

        .chat-meta {
            font-size: 0.7rem;
            margin-bottom: 3px;
            opacity: 0.8;
        }

        /* Ajuste para mÃ³vil */
        @media (max-width: 768px) {
            .btn-texto {
                display: none;
            }

            .filtros-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div id="pantalla-login">
        <div class="card card-login animate-enter">
            <div class="text-center mb-4 login-header">
                <div class="mb-3 animate-enter delay-100"
                    style="font-size: 3.5rem; text-shadow: 0 0 20px rgba(13,110,253,0.5);">ðŸš›</div>
                <h3 class="animate-enter delay-200">Control de Flota</h3>
                <p class="animate-enter delay-300">Seleccione su perfil para ingresar</p>
            </div>

            <div class="role-card-container">
                <!-- Reportador -->
                <button onclick="intentarLogin('reportador')"
                    class="login-role-card role-reportador animate-enter delay-400">
                    <div class="icon-wrapper">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="text-content">
                        <h5>Reportador</h5>
                        <span>Crear nuevos reportes</span>
                    </div>
                    <div class="arrow-icon"><i class="fas fa-chevron-right"></i></div>
                </button>

                <!-- TÃ©cnico -->
                <button onclick="intentarLogin('tecnico')" class="login-role-card role-tecnico animate-enter delay-400"
                    style="animation-delay: 0.5s;">
                    <div class="icon-wrapper">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div class="text-content">
                        <h5>TÃ©cnico</h5>
                        <span>Gestionar reparaciones</span>
                    </div>
                    <div class="arrow-icon"><i class="fas fa-chevron-right"></i></div>
                </button>

                <!-- Supervisor -->
                <button onclick="intentarLogin('supervisor')"
                    class="login-role-card role-supervisor animate-enter delay-400" style="animation-delay: 0.6s;">
                    <div class="icon-wrapper">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="text-content">
                        <h5>Supervisor</h5>
                        <span>AdministraciÃ³n total</span>
                    </div>
                    <div class="arrow-icon"><i class="fas fa-chevron-right"></i></div>
                </button>
            </div>

            <div class="text-center mt-4 animate-enter" style="animation-delay: 0.7s;">
                <small style="color: rgba(255,255,255,0.4);">v2.0 â€¢ Jorge Garavagno</small>
            </div>
        </div>
    </div>

    <div id="pantalla-app" style="display:none;">

        <nav class="navbar navbar-custom sticky-top">
            <div class="container">
                <div class="d-flex align-items-center">
                    <span style="font-size: 1.5rem;" class="me-2">ðŸš›</span>
                    <div>
                        <h5 class="m-0 fw-bold text-dark">GestiÃ³n de Flota</h5>
                        <span class="badge bg-light text-secondary border" id="badgeRolUsuario">Rol: --</span>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button onclick="toggleTheme()" class="btn btn-link nav-link p-2 me-2" id="themeToggle"
                        title="Cambiar tema">
                        <i class="fas fa-moon fs-5"></i>
                    </button>
                    <button id="btnStats" onclick="abrirEstadisticas()" class="btn btn-info text-white shadow-sm"
                        style="display:none;" title="EstadÃ­sticas y Excel">
                        <i class="fas fa-chart-pie"></i> <span class="btn-texto">Reportes</span>
                    </button>
                    <button id="btnAdminFlota" onclick="abrirModalFlota()" class="btn btn-warning shadow-sm"
                        style="display:none;" title="Gestionar Unidades">
                        <i class="fas fa-cogs"></i> <span class="btn-texto">Flota</span>
                    </button>
                    <button onclick="cerrarSesion()" class="btn btn-outline-danger shadow-sm" title="Salir">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </nav>

        <div class="container pb-5">
            <div class="card">
                <div
                    class="card-header bg-primary text-white bg-gradient d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-plus-circle me-2"></i>Nuevo Reporte</span>
                </div>
                <div class="card-body p-4">
                    <form id="reporteForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary">1. Grupo</label>
                                <select class="form-select form-select-lg" id="selectorGrupo"
                                    onchange="cargarUnidades('principal')" required>
                                    <option value="">-- Seleccionar --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary">2. Unidad</label>
                                <select class="form-select form-select-lg" id="selectorUnidad"
                                    onchange="cargarOpcionesFalla()" disabled required>
                                    <option value="">-- Primero elija grupo --</option>
                                </select>
                                <div id="avisoBaja" class="alert alert-danger mt-2 py-2" style="display:none;">
                                    <i class="fas fa-ban me-2"></i>Unidad dada de BAJA
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-light rounded-3 border" id="panelFallas" style="display:none;">
                            <label class="form-label fw-bold text-danger mb-3"><i
                                    class="fas fa-exclamation-circle me-2"></i>3. Marque las fallas:</label>
                            <div id="contenedorCheckboxes" class="d-flex flex-wrap gap-3"></div>
                        </div>
                        <div class="mt-3">
                            <textarea id="observaciones" class="form-control" rows="2"
                                placeholder="Observaciones adicionales..."></textarea>
                        </div>
                        <div class="mt-3">
                            <label class="form-label fw-bold text-danger"><i
                                    class="fas fa-exclamation-triangle me-2"></i>4. Prioridad de la ReparaciÃ³n:</label>
                            <select class="form-select form-select-lg" id="selectorPrioridad" required>
                                <option value="">-- Seleccionar prioridad --</option>
                                <option value="baja">ðŸŸ¢ Baja - Puede esperar</option>
                                <option value="media">ðŸŸ¡ Media - Normal</option>
                                <option value="alta">ðŸŸ  Alta - Importante</option>
                                <option value="urgente">ðŸ”´ Urgente - CrÃ­tico</option>
                            </select>
                            <div class="invalid-feedback">Por favor seleccione una prioridad</div>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg w-100 mt-4 shadow-sm"><i
                                class="fas fa-paper-plane me-2"></i>Enviar Reporte</button>
                    </form>
                </div>
            </div>

            <div class="row mb-4 text-center g-3" id="tableroComando">
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100"
                        style="background: linear-gradient(135deg, #ff9966, #ff5e62); color: white;">
                        <div class="card-body">
                            <h1 class="display-4 fw-bold mb-0" id="contadorPendientes">0</h1>
                            <p class="mb-0"><i class="fas fa-tools me-2"></i>En ReparaciÃ³n</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100"
                        style="background: linear-gradient(135deg, #56ab2f, #a8e063); color: white;">
                        <div class="card-body">
                            <h1 class="display-4 fw-bold mb-0" id="contadorListas">0</h1>
                            <p class="mb-0"><i class="fas fa-check-circle me-2"></i>Reparadas (Lista)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100"
                        style="background: linear-gradient(135deg, #4568dc, #b06ab3); color: white;">
                        <div class="card-body">
                            <h1 class="display-4 fw-bold mb-0" id="contadorBajas">0</h1>
                            <p class="mb-0"><i class="fas fa-ban me-2"></i>Unidades de Baja</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Panel de Filtros -->
            <div id="panelFiltros" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold"><i class="fas fa-filter me-2"></i>Filtros Avanzados</h6>
                    <button onclick="limpiarFiltros()" class="btn btn-sm btn-outline-secondary"><i
                            class="fas fa-times me-1"></i>Limpiar</button>
                </div>
                <div class="filtros-grid">
                    <div>
                        <label class="form-label small fw-bold">Estado</label>
                        <select class="form-select form-select-sm" id="filtroEstado" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Completado">Completado</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label small fw-bold">Prioridad</label>
                        <select class="form-select form-select-sm" id="filtroPrioridad" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <option value="urgente">ðŸ”´ Urgente</option>
                            <option value="alta">ðŸŸ  Alta</option>
                            <option value="media">ðŸŸ¡ Media</option>
                            <option value="baja">ðŸŸ¢ Baja</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="contador-resultados" id="contadorResultados">Mostrando todos los reportes</span>
                </div>
            </div>
            <!-- Panel de Filtros -->
            <div id="panelFiltros" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-bold"><i class="fas fa-filter me-2"></i>Filtros Avanzados</h6>
                    <button onclick="limpiarFiltros()" class="btn btn-sm btn-outline-secondary"><i
                            class="fas fa-times me-1"></i>Limpiar</button>
                </div>
                <div class="filtros-grid">
                    <div>
                        <label class="form-label small fw-bold">Estado</label>
                        <select class="form-select form-select-sm" id="filtroEstado" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Completado">Completado</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label small fw-bold">Prioridad</label>
                        <select class="form-select form-select-sm" id="filtroPrioridad" onchange="aplicarFiltros()">
                            <option value="">Todas</option>
                            <option value="urgente">ðŸ”´ Urgente</option>
                            <option value="alta">ðŸŸ  Alta</option>
                            <option value="media">ðŸŸ¡ Media</option>
                            <option value="baja">ðŸŸ¢ Baja</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="contador-resultados" id="contadorResultados">Mostrando todos los reportes</span>
                </div>
            </div>





            <div class="card">
                <div
                    class="card-header bg-dark text-white d-flex flex-wrap justify-content-between align-items-center py-3">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Reparaciones Pendientes</h5>
                    <div class="d-flex gap-2 align-items-center mt-2 mt-md-0">
                        <button onclick="toggleFiltros()" class="btn btn-sm btn-outline-light"><i
                                class="fas fa-filter me-1"></i><span class="btn-texto">Filtros</span></button>
                        <div class="input-group input-group-sm" style="max-width: 250px;">
                            <span class="input-group-text bg-secondary text-white border-0"><i
                                    class="fas fa-search"></i></span>
                            <input type="text" id="busquedaTabla" class="form-control border-0"
                                placeholder="Buscar unidad...">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 text-center align-middle" id="tablaReportes">
                                <thead class="table-light">
                                    <tr>
                                        <th class="py-3">Unidad <i class="fas fa-sort text-muted ms-1"
                                                style="cursor:pointer;" onclick="ordenarTabla(0)"></i></th>
                                        <th>Fallas</th>
                                        <th>Fecha <i class="fas fa-sort text-muted ms-1" style="cursor:pointer;"
                                                onclick="ordenarTabla(2)"></i></th>
                                        <th>Estado <i class="fas fa-sort text-muted ms-1" style="cursor:pointer;"
                                                onclick="ordenarTabla(3)"></i></th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCuerpo" class="bg-white"></tbody>
                            </table>
                        </div>
                        <div id="loading" class="text-center p-5 text-muted">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 small">Conectando...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="toastNotificacion" class="toast align-items-center text-white border-0" role="alert"
                aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body fs-6"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalDetalles" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <div class="d-flex align-items-center gap-3">
                            <h5 class="modal-title fw-bold m-0"><i class="fas fa-clipboard-list me-2"></i>Detalles del
                                Reporte</h5>
                            <span id="detalleBadgeUnidad" class="badge bg-light text-primary fs-6">Unidad #</span>
                            <span id="detalleBadgePrioridad" class="badge rounded-pill bg-white text-dark"></span>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="row g-0 h-100">
                            <!-- Columna Izquierda: INFO -->
                            <div class="col-md-5 bg-light p-4 border-end">
                                <h6 class="fw-bold text-muted mb-3 text-uppercase small">InformaciÃ³n General</h6>

                                <div class="mb-4">
                                    <label class="text-secondary small fw-bold">Fallas Reportadas</label>
                                    <div id="detalleFallas" class="d-flex flex-wrap gap-1 mt-1"></div>
                                </div>

                                <div class="mb-4">
                                    <label class="text-secondary small fw-bold">Fecha de Ingreso</label>
                                    <p class="mb-0 fw-medium" id="detalleFecha">--/--/----</p>
                                    <small class="text-muted" id="detalleHora">--:--</small>
                                </div>

                                <div class="mb-4">
                                    <label class="text-secondary small fw-bold">Reportado por</label>
                                    <p class="mb-0 text-dark" id="detalleUsuario">Usuario</p>
                                </div>

                                <div class="p-3 bg-white rounded border border-light shadow-sm">
                                    <label class="text-primary small fw-bold mb-2"><i
                                            class="fas fa-comment-alt me-1"></i>ObservaciÃ³n Original</label>
                                    <p class="mb-0 fst-italic text-muted" id="detalleObservacion">...</p>
                                </div>
                            </div>

                            <!-- Columna Derecha: TABS (Historial / Comentarios) -->
                            <div class="col-md-7 p-0 d-flex flex-column" style="min-height: 400px;">
                                <ul class="nav nav-tabs nav-fill bg-white border-bottom" id="tabDetalles"
                                    role="tablist">
                                    <li class="nav-item">
                                        <button class="nav-link active fw-bold py-3" data-bs-toggle="tab"
                                            data-bs-target="#tab-comentarios">
                                            <i class="fas fa-comments me-2"></i>Comentarios
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link fw-bold py-3" data-bs-toggle="tab"
                                            data-bs-target="#tab-historial">
                                            <i class="fas fa-history me-2"></i>Historial
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content flex-grow-1 p-3 bg-white" style="overflow-y: auto;">
                                    <!-- Tab Comentarios -->
                                    <div class="tab-pane fade show active h-100 d-flex flex-column"
                                        id="tab-comentarios">
                                        <div id="listaComentarios"
                                            class="chat-container flex-grow-1 mb-3 border bg-light">
                                            <div class="text-center text-muted py-5"><i
                                                    class="fas fa-comment-slash fa-2x mb-2"></i><br>No hay comentarios
                                                aÃºn</div>
                                        </div>
                                        <div class="input-group">
                                            <input type="text" id="inputNuevoComentario" class="form-control"
                                                placeholder="Escribir nota..."
                                                onkeypress="if(event.key==='Enter') enviarComentario()">
                                            <button class="btn btn-primary" onclick="enviarComentario()"><i
                                                    class="fas fa-paper-plane"></i></button>
                                        </div>
                                    </div>

                                    <!-- Tab Historial -->
                                    <div class="tab-pane fade p-3" id="tab-historial">
                                        <div id="timelineContainer"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalFlota" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title fw-bold text-dark"><i class="fas fa-traffic-light me-2"></i>Gestionar
                            Estado
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <p class="text-muted mb-4">Seleccione unidad para cambiar estado.</p>
                        <div class="mb-3"><label class="fw-bold small text-secondary">Grupo</label><select
                                class="form-select" id="adminSelectorGrupo" onchange="cargarUnidades('admin')">
                                <option value="">-- Seleccionar --</option>
                            </select></div>
                        <div class="mb-4"><label class="fw-bold small text-secondary">Unidad</label><select
                                class="form-select" id="adminSelectorUnidad" onchange="verificarEstadoAdmin()">
                                <option value="">-- Seleccionar --</option>
                            </select></div>
                        <div id="panelAccionAdmin" class="text-center p-4 border rounded bg-light"
                            style="display:none;">
                            <h5 id="lblEstadoActual" class="mb-3 fw-bold"></h5>
                            <button id="btnCambiarEstado" onclick="cambiarEstadoUnidad()"
                                class="btn btn-lg w-100 shadow-sm"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalEstadisticas" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title fw-bold"><i class="fas fa-chart-bar me-2"></i>EstadÃ­sticas y Reportes
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">

                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="text-muted text-center mb-3">DistribuciÃ³n de Fallas</h6>
                                        <canvas id="chartTipos"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="text-muted text-center mb-3">Top Unidades ProblemÃ¡ticas</h6>
                                        <canvas id="chartUnidades"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <button onclick="descargarExcel()" class="btn btn-success btn-lg w-100 shadow">
                                    <i class="fas fa-file-excel me-2"></i>Excel
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button onclick="descargarPDF()" class="btn btn-danger btn-lg w-100 shadow">
                                    <i class="fas fa-file-pdf me-2"></i>PDF
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button id="btn-exportar-chat" onclick="enviarGraficoAChat()"
                                    class="btn btn-primary btn-lg w-100 shadow">
                                    <i class="fas fa-paper-plane me-2"></i>Chat
                                </button>
                            </div>
                            <div class="col-12">
                                <small class="text-muted d-block text-center mt-2">Los archivos incluyen todos los
                                    reportes histÃ³ricos.</small>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            // --- THEME SYSTEM ---
            window.toggleTheme = function () {
                const body = document.body;
                const isDark = body.getAttribute('data-theme') === 'dark';
                const newTheme = isDark ? 'light' : 'dark';

                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            };

            function updateThemeIcon(theme) {
                const btn = document.getElementById('themeToggle');
                if (!btn) return;
                if (theme === 'dark') {
                    btn.innerHTML = '<i class="fas fa-sun fs-5 text-warning"></i>';
                } else {
                    btn.innerHTML = '<i class="fas fa-moon fs-5 text-secondary"></i>';
                }
            }

            // Init Theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            // We'll call updateThemeIcon after DOM load or manually here if button exists
            setTimeout(() => updateThemeIcon(savedTheme), 100);

            // --- ANIMATIONS & NOTIFICATIONS ---

            import { getDatabase, ref, push, update, remove, onChildAdded, onChildChanged, onChildRemoved, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDVeuhJt3jdlkGcLr0nvuJA4qZldZp0eXw",
                authDomain: "gestionflota-ea461.firebaseapp.com",
                databaseURL: "https://gestionflota-ea461-default-rtdb.firebaseio.com",
                projectId: "gestionflota-ea461",
                storageBucket: "gestionflota-ea461.firebasestorage.app",
                messagingSenderId: "43528636288",
                appId: "1:43528636288:web:c8a9f3f740bcfb7e856365"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const dbRef = ref(db, 'reparaciones');
            const dbFlotaRef = ref(db, 'estado_flota');

            let rolActual = "";
            let mapaBajas = {};
            let chartInstanceTipos = null;
            let chartInstanceUnidades = null;

            // --- NUEVO: CONFIGURACIÃ“N DE SONIDO ---
            const sonidoAlerta = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
            let tiempoInicioSesion = new Date(); // Registramos cuÃ¡ndo abriÃ³ la app

            // --- LOGIN ---
            window.intentarLogin = function (rol) {
                let pass = null;
                if (rol === 'tecnico') {
                    pass = prompt("Ingrese Clave de TÃ©cnico:");
                    if (pass !== atob("MTIzNA==")) { mostrarToast('â›” Clave incorrecta', 'danger'); return; }
                } else if (rol === 'supervisor') {
                    pass = prompt("Ingrese Clave de Supervisor:");
                    if (pass !== atob("YWRtaW4=")) { mostrarToast('â›” Clave incorrecta', 'danger'); return; }
                }
                let nombreRol = rol.charAt(0).toUpperCase() + rol.slice(1);
                if (rol === 'tecnico') nombreRol = 'TÃ©cnico'; // Ajuste tilde

                // Reiniciamos el tiempo para que empiecen a sonar las alertas desde AHORA
                tiempoInicioSesion = new Date();

                iniciarApp(nombreRol);
            };

            function iniciarApp(rolNombre) {
                rolActual = rolNombre;
                document.getElementById('pantalla-login').style.display = 'none';
                document.getElementById('pantalla-app').style.display = 'block';
                document.getElementById('badgeRolUsuario').innerText = rolActual;

                if (rolActual === 'Supervisor') {
                    document.getElementById('btnAdminFlota').style.display = 'block';
                    document.getElementById('btnStats').style.display = 'block';
                }
                activarEscuchasFirebase();
            }
            window.cerrarSesion = function () { location.reload(); };

            // --- CONFIG FLOTA ---
            const configFlota = [
                { label: "Serie 0100 (0104-0200)", min: 104, max: 200, caps: ["GPS"] },
                { label: "Serie 1000 A (1016-1081)", min: 1016, max: 1081, caps: ["GPS", "RFID", "Censado", "NVR"] },
                { label: "Serie 1100 (1121-1150)", min: 1121, max: 1150, caps: ["GPS", "NVR"] },
                { label: "Serie 1200 (1204-1235)", min: 1204, max: 1235, caps: ["GPS", "Censado"] },
                { label: "Serie 1300 (1304-1312)", min: 1304, max: 1312, caps: ["GPS"] },
                { label: "Serie 1400 (1407-1421)", min: 1407, max: 1421, caps: ["GPS"] },
                { label: "Serie 1600 (1604-1610)", min: 1604, max: 1610, caps: ["GPS", "RFID", "Censado"] },
                { label: "Serie 1700 (1704-1727)", min: 1704, max: 1727, caps: ["GPS", "Censado", "NVR"] },
                { label: "Serie 1900 (1902-1927)", min: 1902, max: 1927, caps: ["GPS", "NVR"] },
                { label: "Especial (1950)", min: 1950, max: 1950, caps: ["GPS"] }
            ];

            const selectGrupo = document.getElementById('selectorGrupo');
            const adminSelectGrupo = document.getElementById('adminSelectorGrupo');
            configFlota.forEach((grupo, index) => {
                let opt = new Option(grupo.label, index);
                selectGrupo.appendChild(opt);
                adminSelectGrupo.appendChild(opt.cloneNode(true));
            });

            // --- CARGA UNIDADES ---
            window.cargarUnidades = function (tipo) {
                const idSelectorGrupo = tipo === 'principal' ? 'selectorGrupo' : 'adminSelectorGrupo';
                const idSelectorUnidad = tipo === 'principal' ? 'selectorUnidad' : 'adminSelectorUnidad';
                const index = document.getElementById(idSelectorGrupo).value;
                const selectUnidad = document.getElementById(idSelectorUnidad);

                selectUnidad.innerHTML = '<option value="">-- Seleccionar --</option>';
                if (tipo === 'principal') {
                    document.getElementById('panelFallas').style.display = 'none';
                    document.getElementById('avisoBaja').style.display = 'none';
                } else {
                    document.getElementById('panelAccionAdmin').style.display = 'none';
                }
                if (index === "") { selectUnidad.disabled = true; return; }

                const grupo = configFlota[index];
                selectUnidad.disabled = false;
                for (let i = grupo.min; i <= grupo.max; i++) {
                    let opt = document.createElement('option');
                    let num = i.toString().padStart(4, '0');
                    opt.value = num;
                    let estaDeBaja = mapaBajas[num] === true;
                    if (tipo === 'principal') {
                        if (estaDeBaja) {
                            opt.text = `${num} (FUERA DE SERVICIO)`; opt.disabled = true; opt.classList.add('fuera-servicio');
                        } else { opt.text = num; }
                    } else {
                        if (estaDeBaja) {
                            opt.text = `${num} ðŸ”´ BAJA`; opt.style.color = 'red';
                        } else { opt.text = `${num} ðŸŸ¢ OK`; }
                    }
                    selectUnidad.appendChild(opt);
                }
            }

            window.cargarOpcionesFalla = function () {
                const index = document.getElementById('selectorGrupo').value;
                const contenedor = document.getElementById('contenedorCheckboxes');
                const panel = document.getElementById('panelFallas');
                if (index === "") return;
                contenedor.innerHTML = ''; panel.style.display = 'block';
                configFlota[index].caps.forEach(cap => {
                    let div = document.createElement('div');
                    div.className = 'form-check form-switch';
                    div.innerHTML = `<input class="form-check-input" type="checkbox" name="fallas" value="${cap}" id="chk_${cap}"><label class="form-check-label ps-2" for="chk_${cap}">${cap}</label>`;
                    contenedor.appendChild(div);
                });
            }

            // --- GESTIÃ“N FLOTA ---
            window.abrirModalFlota = function () { new bootstrap.Modal(document.getElementById('modalFlota')).show(); };
            window.verificarEstadoAdmin = function () {
                const unidad = document.getElementById('adminSelectorUnidad').value;
                if (!unidad) { document.getElementById('panelAccionAdmin').style.display = 'none'; return; }
                document.getElementById('panelAccionAdmin').style.display = 'block';
                const lbl = document.getElementById('lblEstadoActual');
                const btn = document.getElementById('btnCambiarEstado');
                if (mapaBajas[unidad] === true) {
                    lbl.innerHTML = `Unidad ${unidad}: <span class="text-danger">FUERA DE SERVICIO</span>`;
                    btn.innerHTML = `<i class="fas fa-check-circle me-2"></i>REHABILITAR UNIDAD`; btn.className = "btn btn-success w-100 shadow";
                    btn.onclick = function () { toggleBaja(unidad, false); };
                } else {
                    lbl.innerHTML = `Unidad ${unidad}: <span class="text-success">OPERATIVA</span>`;
                    btn.innerHTML = `<i class="fas fa-ban me-2"></i>DAR DE BAJA`; btn.className = "btn btn-danger w-100 shadow";
                    btn.onclick = function () { toggleBaja(unidad, true); };
                }
            };
            function toggleBaja(unidad, darDeBaja) {
                const refUnidad = ref(db, `estado_flota/${unidad}`);
                if (darDeBaja) { set(refUnidad, true).then(() => mostrarToast(`Unidad ${unidad} dada de BAJA`, 'success')); }
                else { remove(refUnidad).then(() => mostrarToast(`Unidad ${unidad} REHABILITADA`, 'success')); }
                setTimeout(() => { cargarUnidades('admin'); document.getElementById('adminSelectorUnidad').value = unidad; verificarEstadoAdmin(); cargarUnidades('principal'); }, 500);
            }

            // --- ESTADÃSTICAS Y EXCEL ---
            window.abrirEstadisticas = function () {
                new bootstrap.Modal(document.getElementById('modalEstadisticas')).show();

                // Obtener datos para grÃ¡ficos
                get(dbRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        let conteoFallas = {};
                        let conteoUnidades = {};

                        Object.values(data).forEach(reporte => {
                            // Contar fallas
                            if (reporte.fallas) {
                                reporte.fallas.forEach(f => {
                                    conteoFallas[f] = (conteoFallas[f] || 0) + 1;
                                });
                            }
                            // Contar unidad problemÃ¡tica
                            conteoUnidades[reporte.unidad] = (conteoUnidades[reporte.unidad] || 0) + 1;
                        });

                        // Renderizar grÃ¡ficos
                        renderizarCharts(conteoFallas, conteoUnidades);
                    }
                });
            };

            function renderizarCharts(fallas, unidades) {
                const ctxTipos = document.getElementById('chartTipos').getContext('2d');
                const ctxUnidades = document.getElementById('chartUnidades').getContext('2d');

                if (chartInstanceTipos) chartInstanceTipos.destroy();
                if (chartInstanceUnidades) chartInstanceUnidades.destroy();

                // 1. Chart Tipos (Pie)
                chartInstanceTipos = new Chart(ctxTipos, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(fallas),
                        datasets: [{
                            data: Object.values(fallas),
                            backgroundColor: ['#dc3545', '#ffc107', '#0dcaf0', '#198754'],
                            borderWidth: 0
                        }]
                    }
                });

                // 2. Chart Unidades (Bar) - Top 5
                const topUnidades = Object.entries(unidades)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                chartInstanceUnidades = new Chart(ctxUnidades, {
                    type: 'bar',
                    data: {
                        labels: topUnidades.map(u => u[0]),
                        datasets: [{
                            label: 'Reportes',
                            data: topUnidades.map(u => u[1]),
                            backgroundColor: '#0d6efd',
                            borderRadius: 5
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
            }

            window.descargarExcel = function () {
                get(dbRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const rawData = snapshot.val();
                        const dataParaExcel = Object.keys(rawData).map(key => {
                            const r = rawData[key];
                            return {
                                Unidad: r.unidad,
                                Fallas: Array.isArray(r.fallas) ? r.fallas.join(", ") : r.fallas,
                                Fecha: r.fecha,
                                Hora: r.hora,
                                Estado: r.estado,
                                Usuario: r.usuario || "Desconocido",
                                Observaciones: r.observaciones || ""
                            };
                        });
                        const ws = XLSX.utils.json_to_sheet(dataParaExcel);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Reportes");
                        XLSX.writeFile(wb, "Reportes_Flota_" + new Date().toISOString().slice(0, 10) + ".xlsx");
                    } else {
                        mostrarToast("No hay datos para exportar", "warning");
                    }
                });
            };

            // --- EXPORTACIÃ“N PDF ---
            window.descargarPDF = function () {
                mostrarToast('â³ Generando PDF...', 'info');

                get(dbRef).then((snapshot) => {
                    if (!snapshot.exists()) {
                        mostrarToast("No hay datos para exportar", "warning");
                        return;
                    }

                    const rawData = snapshot.val();
                    const reportes = Object.values(rawData);

                    // Ordenar por fecha (opcional)
                    reportes.sort((a, b) => {
                        // Parse simple de fecha dd/mm/aaaa
                        const [dA, mA, yA] = a.fecha.split('/');
                        const [dB, mB, yB] = b.fecha.split('/');
                        return new Date(yB, mB - 1, dB) - new Date(yA, mA - 1, dA);
                    });

                    // Crear elemento temporal para el PDF
                    const elemento = document.createElement('div');
                    elemento.style.width = '100%';
                    elemento.style.padding = '20px';
                    elemento.style.fontFamily = 'Helvetica, Arial, sans-serif'; // Fuente segura para PDF
                    elemento.style.color = '#333';

                    // Construir HTML del reporte
                    let html = `
                        <div style="text-align:center; margin-bottom: 20px; border-bottom: 2px solid #0d6efd; padding-bottom: 10px;">
                            <h2 style="color:#0d6efd; margin: 0;">REPORTE DE FLOTA</h2>
                            <p style="color:#6c757d; margin: 5px 0;">Generado el ${new Date().toLocaleDateString('es-AR')} a las ${new Date().toLocaleTimeString('es-AR')}</p>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <div><strong>Total:</strong> ${reportes.length}</div>
                            <div><strong>Pendientes:</strong> ${reportes.filter(r => r.estado !== 'Completado').length}</div>
                            <div><strong>Reparados:</strong> ${reportes.filter(r => r.estado === 'Completado').length}</div>
                        </div>

                        <table style="width:100%; border-collapse: collapse; font-size: 10px;">
                            <thead>
                                <tr style="background-color: #343a40; color: white;">
                                    <th style="padding: 8px; text-align: left;">Unidad</th>
                                    <th style="padding: 8px; text-align: left;">Fallas</th>
                                    <th style="padding: 8px; text-align: left;">Prioridad</th>
                                    <th style="padding: 8px; text-align: left;">Ingreso</th>
                                    <th style="padding: 8px; text-align: left;">Estado</th>
                                    <th style="padding: 8px; text-align: left;">ReportÃ³</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    reportes.forEach((r, index) => {
                        const bg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                        const fallasStr = Array.isArray(r.fallas) ? r.fallas.join(", ") : r.fallas;
                        const estadoColor = r.estado === 'Completado' ? '#198754' : '#6c757d';

                        html += `
                            <tr style="background-color: ${bg}; border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 6px;"><strong>${r.unidad}</strong></td>
                                <td style="padding: 6px;">${fallasStr}</td>
                                <td style="padding: 6px;">${(r.prioridad || '-').toUpperCase()}</td>
                                <td style="padding: 6px;">${r.fecha}</td>
                                <td style="padding: 6px;"><span style="color: ${estadoColor}; font-weight: bold;">${r.estado}</span></td>
                                <td style="padding: 6px;">${r.usuario || '-'}</td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table>
                    <div style="margin-top: 20px; font-size: 9px; text-align: center; color: #aaa;">
                        Fin del reporte - FleetCommand v2.0
                    </div>`;

                    elemento.innerHTML = html;

                    // ConfiguraciÃ³n PDF
                    const opt = {
                        margin: [0.5, 0.5], // top/bottom, left/right
                        filename: `Reporte_Flota_${new Date().toISOString().slice(0, 10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: 'avoid-all', before: '.page-break' }
                    };

                    // Generar y Guardar
                    html2pdf().set(opt).from(elemento).save()
                        .then(() => mostrarToast('âœ… PDF descargado exitosamente', 'success'))
                        .catch(err => {
                            console.error("Error PDF:", err);
                            mostrarToast('âŒ Error al generar PDF', 'danger');
                        });
                });
            };

            // --- EXPORTACIÃ“N GOOGLE CHAT CON IMGBB ---
            async function enviarGraficoAChat() {
                const IMGBB_KEY = atob("YmQ5YmU2NmYxZjAxM2ViNGMyMGY5Nzk5MDQ3M2UzOTQ=");
                const WEBHOOK_URL = atob("aHR0cHM6Ly9jaGF0Lmdvb2dsZWFwaXMuY29tL3YxL3NwYWNlcy9BQVFBaV90Tk9BOC9tZXNzYWdlcz9rZXk9QUl6YVN5RGRJMGhDWnRFNnZ5U2pNbS1XRWZScTNDUHpxS3Fxc0hJJnRva2VuPUtIMWtTaFJmcVZxUjEtNDRqSVFyVHRVZmxseTZvbXlsTUlXSi1oQm5LdG8=");
                const canvas = document.getElementById('chartTipos'); // Usamos el grÃ¡fico de distribuciÃ³n
                const boton = document.getElementById('btn-exportar-chat');

                if (!canvas) {
                    mostrarToast("No se encontrÃ³ el grÃ¡fico para exportar.", "danger");
                    return;
                }

                boton.disabled = true;
                const originalContent = boton.innerHTML;
                boton.innerText = "Preparando...";

                try {
                    // 1. Obtener imagen en Base64
                    const dataUrl = canvas.toDataURL("image/png");
                    const base64Image = dataUrl.split(',')[1];

                    // 2. Subir a ImgBB
                    boton.innerText = "Subiendo (ImgBB)...";
                    const formData = new FormData();
                    formData.append("image", base64Image);

                    const imgbbResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                        method: "POST",
                        body: formData,
                    });

                    const imgbbData = await imgbbResponse.json();

                    if (!imgbbData.success) {
                        throw new Error("ImgBB rechazÃ³ la imagen: " + (imgbbData.error ? imgbbData.error.message : "Error desconocido"));
                    }

                    const downloadUrl = imgbbData.data.url;

                    // 3. Enviar a Google Chat Webhook
                    boton.innerText = "Enviando al chat...";

                    const mensajeChat = {
                        cardsV2: [{
                            cardId: "reporte-flota-" + Date.now(),
                            card: {
                                header: {
                                    title: "Reporte de Estado de Flota",
                                    subtitle: "DistribuciÃ³n (vÃ­a ImgBB)",
                                    imageUrl: "https://www.gstatic.com/images/icons/material/system/2x/insert_chart_grey600_48dp.png",
                                    imageType: "CIRCLE"
                                },
                                sections: [{
                                    widgets: [
                                        { textParagraph: { text: "Estado actual de la flota (GrÃ¡fico de distribuciÃ³n):" } },
                                        { image: { imageUrl: downloadUrl, altText: "GrÃ¡fico de Reportes" } }
                                    ]
                                }]
                            }
                        }]
                    };

                    const response = await fetch(WEBHOOK_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json; charset=UTF-8" },
                        body: JSON.stringify(mensajeChat),
                    });

                    if (response.ok) {
                        mostrarToast("âœ… Â¡Reporte enviado correctamente!", "success");
                    } else {
                        throw new Error("Error en respuesta del servidor de Chat");
                    }

                } catch (error) {
                    console.error("Error en el proceso:", error);
                    mostrarToast("âŒ Error: " + error.message, "danger");
                } finally {
                    boton.disabled = false;
                    boton.innerHTML = originalContent;
                }
            }
            window.enviarGraficoAChat = enviarGraficoAChat;

            // --- FORM SUBMIT ---
            // --- VALIDACIONES EN TIEMPO REAL ---
            const camposRequeridos = ['selectorGrupo', 'selector Unidad', 'selectorPrioridad'];

            document.getElementById('selectorPrioridad').addEventListener('change', function () {
                if (this.value) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });

            document.getElementById('reporteForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const unidad = document.getElementById('selectorUnidad').value;
                const prioridad = document.getElementById('selectorPrioridad').value;
                const obs = document.getElementById('observaciones').value.trim();
                const checkboxes = document.querySelectorAll('input[name="fallas"]:checked');

                // Validaciones
                if (!unidad || checkboxes.length === 0 || !prioridad) {
                    mostrarToast('âš ï¸ Faltan datos obligatorios', 'danger');
                    if (!prioridad) document.getElementById('selectorPrioridad').classList.add('is-invalid');
                    return;
                }

                let listaFallas = Array.from(checkboxes).map(cb => cb.value);
                push(dbRef, {
                    unidad: unidad,
                    fallas: listaFallas,
                    observaciones: obs,
                    prioridad: prioridad,
                    fecha: new Date().toLocaleDateString('es-AR'),
                    hora: new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' }),
                    estado: "Pendiente",
                    usuario: rolActual
                }).then(() => {
                    mostrarToast('âœ… Reporte enviado.', 'success');
                    document.getElementById('reporteForm').reset();
                    document.getElementById('panelFallas').style.display = 'none';
                    document.getElementById('selectorUnidad').disabled = true;
                    document.getElementById('selectorUnidad').innerHTML = '<option value="">-- Primero elija grupo --</option>';
                    document.getElementById('selectorPrioridad').classList.remove('is-valid');
                });
            });

            // --- ACCIONES TABLA ---
            window.marcarCompletado = function (id) {
                if (confirm("Â¿Confirmar reparaciÃ³n completada?")) {
                    update(ref(db, 'reparaciones/' + id), { estado: "Completado", fechaResolucion: new Date().toLocaleDateString('es-AR') })
                        .then(() => mostrarToast('ðŸ‘ ReparaciÃ³n completada.', 'success'));
                }
            };
            window.eliminarReporte = function (id) {
                if (confirm("Â¿Eliminar este reporte?")) {
                    remove(ref(db, 'reparaciones/' + id)).then(() => mostrarToast('ðŸ—‘ï¸ Reporte eliminado.', 'success'));
                }
            };

            window.abrirDetalles = function (id) {
                const repRef = ref(db, 'reparaciones/' + id);
                get(repRef).then((snap) => {
                    if (!snap.exists()) return;
                    const data = snap.val();
                    const modal = new bootstrap.Modal(document.getElementById('modalDetalles'));

                    // Llenar info bÃ¡sica
                    document.getElementById('detalleBadgeUnidad').innerText = `Unidad #${data.unidad}`;
                    document.getElementById('detalleFecha').innerText = data.fecha;
                    document.getElementById('detalleHora').innerText = data.hora;
                    document.getElementById('detalleUsuario').innerText = data.usuario || 'Desconocido';
                    document.getElementById('detalleObservacion').innerText = data.observaciones || 'Sin observaciones.';

                    // Prioridad
                    const badgeP = document.getElementById('detalleBadgePrioridad');
                    badgeP.className = `badge rounded-pill bg-white text-dark border`;
                    badgeP.innerText = (data.prioridad || 'media').toUpperCase();

                    // Fallas
                    const contFallas = document.getElementById('detalleFallas');
                    contFallas.innerHTML = (data.fallas || []).map(f => `<span class="badge bg-danger">${f}</span>`).join(' ');

                    // ID temporal para comentarios
                    document.getElementById('modalDetalles').dataset.currentId = id;

                    // Cargar Comentarios
                    cargarComentarios(id);

                    modal.show();
                });
            };

            function cargarComentarios(id) {
                const comRef = ref(db, `reparaciones/${id}/comentarios`);
                onValue(comRef, (snap) => {
                    const cont = document.getElementById('listaComentarios');
                    cont.innerHTML = "";
                    if (!snap.exists()) {
                        cont.innerHTML = '<div class="text-center text-muted py-5">No hay comentarios aÃºn</div>';
                        return;
                    }
                    snap.forEach(child => {
                        const c = child.val();
                        const div = document.createElement('div');
                        div.className = "p-2 border-bottom small";
                        div.innerHTML = `<strong>${c.usuario}:</strong> ${c.texto} <br><small class="text-muted">${c.fecha}</small>`;
                        cont.appendChild(div);
                    });
                    cont.scrollTop = cont.scrollHeight;
                });
            }

            window.enviarComentario = function () {
                const id = document.getElementById('modalDetalles').dataset.currentId;
                const input = document.getElementById('inputNuevoComentario');
                const texto = input.value.trim();
                if (!texto || !id) return;

                push(ref(db, `reparaciones/${id}/comentarios`), {
                    usuario: rolActual,
                    texto: texto,
                    fecha: new Date().toLocaleString('es-AR')
                }).then(() => {
                    input.value = "";
                });
            };

            window.enviarNotificacionEscritorio = function (titulo, msg) {
                if (!("Notification" in window)) return;
                if (Notification.permission === "granted") {
                    new Notification(titulo, { body: msg, icon: 'https://cdn-icons-png.flaticon.com/512/711/711192.png' });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") new Notification(titulo, { body: msg });
                    });
                }
            };

            // --- LÃ“GICA DASHBOARD ---
            function actualizarTablero() {
                const filas = document.querySelectorAll('#tablaCuerpo tr');
                let pendientes = 0;
                let listas = 0;
                filas.forEach(fila => {
                    if (fila.classList.contains('table-success')) { listas++; } else { pendientes++; }
                });
                document.getElementById('contadorPendientes').innerText = pendientes;
                document.getElementById('contadorListas').innerText = listas;
                const totalBajas = Object.keys(mapaBajas).length;
                document.getElementById('contadorBajas').innerText = totalBajas;
            }

            // --- ESCUCHAS FIREBASE ---
            function activarEscuchasFirebase() {
                document.getElementById('tablaCuerpo').innerHTML = "";

                onValue(dbFlotaRef, (snapshot) => {
                    mapaBajas = snapshot.val() || {};
                    if (document.getElementById('selectorGrupo').value !== "") cargarUnidades('principal');
                    actualizarTablero();
                });

                onChildAdded(dbRef, (snap) => {
                    document.getElementById('loading').style.display = 'none';

                    // --- NUEVA LÃ“GICA DE SONIDO ---
                    // Solo suena si el reporte es NUEVO (se creÃ³ despuÃ©s de iniciar sesiÃ³n)
                    // Y si no estÃ¡ completado
                    const data = snap.val();

                    if (data.fecha && data.hora) {
                        // Parseamos la fecha del reporte "dd/mm/yyyy" y hora "HH:mm"
                        const [dia, mes, anio] = data.fecha.split('/');
                        const [horas, minutos] = data.hora.split(':');
                        const fechaReporte = new Date(anio, mes - 1, dia, horas, minutos);

                        // Si la fecha del reporte es MAYOR a la hora de login, suena
                        if (fechaReporte > tiempoInicioSesion && data.estado !== 'Completado') {
                            sonidoAlerta.play().catch(e => console.log("Sonido bloqueado por navegador", e));
                            mostrarToast("ðŸ”” Â¡Nuevo ingreso de reparaciÃ³n!", "warning");
                        }
                    }

                    crearFila(snap.key, data);
                    actualizarTablero();
                });

                onChildChanged(dbRef, (snap) => {
                    let f = document.getElementById(snap.key);
                    if (f) f.remove();
                    crearFila(snap.key, snap.val());
                    actualizarTablero();
                });

                onChildRemoved(dbRef, (snap) => {
                    let f = document.getElementById(snap.key);
                    if (f) f.remove();
                    actualizarTablero();
                });
            }

            function crearFila(key, data, esNuevo = false) {
                // NotificaciÃ³n de escritorio si es nuevo y no soy yo
                if (esNuevo && data.usuario !== rolActual) {
                    enviarNotificacionEscritorio("Nuevo Reporte", `Unidad ${data.unidad}: ${data.prioridad || 'Normal'}`);
                }

                let badges = (data.fallas || []).map(f => `<span class="badge rounded-pill ${f === 'GPS' ? 'bg-danger' : f === 'RFID' ? 'bg-warning text-dark' : f === 'NVR' ? 'bg-info text-dark' : 'bg-success'} badge-falla border border-light shadow-sm">${f}</span>`).join('');
                let acciones = `<button onclick="abrirDetalles('${key}')" class="btn btn-sm btn-outline-info me-1 border-0"><i class="fas fa-eye"></i></button>`;

                if (rolActual === 'TÃ©cnico' || rolActual === 'Supervisor') {
                    if (data.estado !== "Completado") acciones += `<button onclick="marcarCompletado('${key}')" class="btn btn-sm btn-outline-success me-1" title="Listo"><i class="fas fa-check"></i></button>`;
                    if (rolActual === 'Supervisor') acciones += `<button onclick="eliminarReporte('${key}')" class="btn btn-sm btn-outline-danger" title="Eliminar"><i class="fas fa-trash-alt"></i></button>`;
                }

                const html = `<tr id="${key}" class="${data.estado === "Completado" ? "table-success bg-opacity-25" : ""}">
            <td class="fw-bold text-dark">${data.unidad}</td><td>${badges}</td><td>${data.fecha}<br><small class="text-muted">${data.hora}</small></td>
            <td>${data.estado === "Completado" ? '<span class="badge rounded-pill bg-success">Listo</span>' : '<span class="badge rounded-pill bg-secondary">Pendiente</span>'}</td>
            <td>${acciones}</td></tr>`;
                document.getElementById('tablaCuerpo').insertAdjacentHTML('afterbegin', html);
            }


            // --- FILTROS AVANZADOS ---
            window.toggleFiltros = function () {
                const panel = document.getElementById('panelFiltros');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            };

            window.aplicarFiltros = function () {
                const filtroEstado = document.getElementById('filtroEstado').value;
                const filtroPrioridad = document.getElementById('filtroPrioridad').value;
                const filas = document.querySelectorAll('#tablaCuerpo tr');
                let contador = 0;

                filas.forEach(fila => {
                    const estado = fila.querySelector('td:nth-child(4)')?.textContent.includes('Listo') ? 'Completado' : 'Pendiente';
                    const prioridad = fila.dataset.prioridad || '';

                    let mostrar = true;

                    if (filtroEstado && estado !== filtroEstado) mostrar = false;
                    if (filtroPrioridad && prioridad !== filtroPrioridad) mostrar = false;

                    fila.style.display = mostrar ? '' : 'none';
                    if (mostrar) contador++;
                });

                document.getElementById('contadorResultados').textContent =
                    contador === filas.length ? 'Mostrando todos los reportes' :
                        `Mostrando ${contador} de ${filas.length} reportes`;
            };

            window.limpiarFiltros = function () {
                document.getElementById('filtroEstado').value = '';
                document.getElementById('filtroPrioridad').value = '';
                document.getElementById('busquedaTabla').value = '';
                document.querySelectorAll('#tablaCuerpo tr').forEach(row => row.style.display = '');
                document.getElementById('contadorResultados').textContent = 'Mostrando todos los reportes';
            };

            // UI Helpers
            document.getElementById('busquedaTabla').addEventListener('input', function () {
                const filter = this.value.toLowerCase();
                document.querySelectorAll('#tablaCuerpo tr').forEach(row => row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none');
            });
            let ordenAsc = true;
            window.ordenarTabla = function (colIndex) {
                const table = document.getElementById('tablaReportes');
                const rows = Array.from(table.tBodies[0].rows);
                rows.sort((a, b) => ordenAsc ? a.cells[colIndex].textContent.localeCompare(b.cells[colIndex].textContent) : b.cells[colIndex].textContent.localeCompare(a.cells[colIndex].textContent));
                ordenAsc = !ordenAsc; rows.forEach(row => table.tBodies[0].appendChild(row));
            };
            function mostrarToast(mensaje, tipo = 'info') {
                const t = document.getElementById('toastNotificacion'); t.querySelector('.toast-body').innerHTML = mensaje;
                t.className = `toast align-items-center text-white border-0 text-bg-${tipo}`; new bootstrap.Toast(t).show();
            }
        </script>
</body>

</html>