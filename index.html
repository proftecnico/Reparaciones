<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Flota - Acceso</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .fuera-servicio { background-color: #e9ecef; color: #6c757d; font-style: italic; }
        .badge-falla { margin-right: 5px; font-size: 0.9em; }
        .table-responsive { max-height: 600px; overflow-y: auto; }
        tr { transition: all 0.5s ease; }
        
        /* Estilos para pantalla de Login */
        #pantalla-login {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
        }
        #pantalla-app { display: none; } /* Oculto al principio */
        .card-login { width: 100%; max-width: 400px; }
    </style>
</head>
<body class="bg-light">

<div id="pantalla-login">
    <div class="card shadow card-login p-4">
        <h3 class="text-center mb-4">üîê Control de Flota</h3>
        <p class="text-center text-muted">Seleccione su perfil para ingresar:</p>
        
        <div class="d-grid gap-3">
            <button onclick="intentarLogin('reportador')" class="btn btn-outline-primary btn-lg">
                üìù Soy Reportador
            </button>
            <button onclick="intentarLogin('tecnico')" class="btn btn-outline-success btn-lg">
                üîß Soy T√©cnico
            </button>
            <button onclick="intentarLogin('supervisor')" class="btn btn-outline-dark btn-lg">
                üëÆ Soy Supervisor
            </button>
        </div>
    </div>
</div>

<div id="pantalla-app" class="container mt-4 mb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üõ†Ô∏è Sistema de Reportes</h2>
            <span class="badge bg-secondary" id="badgeRolUsuario">Rol: --</span>
        </div>
        <button onclick="cerrarSesion()" class="btn btn-sm btn-outline-danger">Cerrar Sesi√≥n üîí</button>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Nuevo Reporte</h5>
        </div>
        <div class="card-body">
            <form id="reporteForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">1. Grupo</label>
                        <select class="form-select" id="selectorGrupo" onchange="cargarUnidades()" required>
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">2. Unidad</label>
                        <select class="form-select" id="selectorUnidad" onchange="cargarOpcionesFalla()" disabled required>
                            <option value="">-- Primero elija grupo --</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3 p-3 bg-white border rounded" id="panelFallas" style="display:none;">
                    <label class="form-label fw-bold text-danger">3. Fallas:</label>
                    <div id="contenedorCheckboxes" class="d-flex flex-wrap gap-3"></div>
                </div>
                <div class="mb-3">
                    <textarea id="observaciones" class="form-control" rows="2" placeholder="Observaciones..."></textarea>
                </div>
                <button type="submit" class="btn btn-success w-100 fw-bold">‚ûï Enviar Reporte</button>
            </form>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">üìã Tablero de Control</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 text-center align-middle">
                    <thead class="table-secondary sticky-top">
                        <tr>
                            <th>Unidad</th>
                            <th>Fallas</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCuerpo">
                        </tbody>
                </table>
            </div>
            <div id="loading" class="text-center p-3 text-muted">
                <div class="spinner-border spinner-border-sm" role="status"></div> Conectando...
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, update, remove, onChildAdded, onChildChanged, onChildRemoved, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- 1. CONFIGURACI√ìN FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVeuhJt3jdlkGcLr0nvuJA4qZldZp0eXw",
        authDomain: "gestionflota-ea461.firebaseapp.com",
        databaseURL: "https://gestionflota-ea461-default-rtdb.firebaseio.com",
        projectId: "gestionflota-ea461",
        storageBucket: "gestionflota-ea461.firebasestorage.app",
        messagingSenderId: "43528636288",
        appId: "1:43528636288:web:c8a9f3f740bcfb7e856365"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'reparaciones');

    // VARIABLE GLOBAL DE ROL
    let rolActual = ""; 

    // --- 2. SISTEMA DE LOGIN ---
    window.intentarLogin = function(rol) {
        if (rol === 'reportador') {
            iniciarApp('Reportador');
        } else if (rol === 'tecnico') {
            let pass = prompt("Ingrese la clave de T√©cnico:");
            if (pass === "1234") iniciarApp('T√©cnico');
            else alert("Clave incorrecta");
        } else if (rol === 'supervisor') {
            let pass = prompt("Ingrese la clave de Supervisor:");
            if (pass === "admin") iniciarApp('Supervisor');
            else alert("Clave incorrecta");
        }
    };

    function iniciarApp(rolNombre) {
        rolActual = rolNombre;
        document.getElementById('pantalla-login').style.display = 'none';
        document.getElementById('pantalla-app').style.display = 'block';
        document.getElementById('badgeRolUsuario').innerText = "Rol: " + rolActual;
        
        // AQU√ç EST√Å EL CAMBIO CLAVE:
        // Activamos Firebase reci√©n AHORA, cuando ya sabemos qui√©n es el usuario.
        activarEscuchasFirebase(); 
    }

    window.cerrarSesion = function() {
        location.reload(); // Recarga la p√°gina para limpiar todo
    };

    // --- 3. L√ìGICA DE FLOTA Y UI ---
    const configFlota = [
        { label: "Serie 0100 (0104-0186)", min: 104, max: 186, caps: ["GPS"] },
        { label: "Serie 1000 A (1016-1081)", min: 1016, max: 1081, caps: ["GPS", "RFID", "Censado", "NVR"] },
        { label: "Serie 1100 (1121-1150)", min: 1121, max: 1150, caps: ["GPS", "NVR"] },
        { label: "Serie 1200 (1204-1235)", min: 1204, max: 1235, caps: ["GPS", "Censado"] },
        { label: "Serie 1300 (1304-1312)", min: 1304, max: 1312, caps: ["GPS"] },
        { label: "Serie 1400 (1407-1421)", min: 1407, max: 1421, caps: ["GPS"] },
        { label: "Serie 1600 (1604-1610)", min: 1604, max: 1610, caps: ["GPS", "RFID", "Censado"] },
        { label: "Serie 1700 (1704-1727)", min: 1704, max: 1727, caps: ["GPS", "Censado", "NVR"] },
        { label: "Serie 1900 (1902-1927)", min: 1902, max: 1927, caps: ["GPS", "NVR"] },
        { label: "Especial (1950)", min: 1950, max: 1950, caps: ["GPS"] }
    ];
    const unidadesFueraDeServicio = [1020, 1021]; 

    window.cargarUnidades = function() {
        const index = document.getElementById('selectorGrupo').value;
        const selectUnidad = document.getElementById('selectorUnidad');
        const panelFallas = document.getElementById('panelFallas');
        selectUnidad.innerHTML = '<option value="">-- Seleccionar --</option>';
        selectUnidad.disabled = true; panelFallas.style.display = 'none';
        if (index === "") return;
        const grupo = configFlota[index]; selectUnidad.disabled = false;
        for (let i = grupo.min; i <= grupo.max; i++) {
            let opt = document.createElement('option');
            let num = i.toString().padStart(4, '0');
            opt.value = num;
            if (unidadesFueraDeServicio.includes(i)) {
                opt.text = `${num} (BAJA)`; opt.disabled = true; opt.classList.add('fuera-servicio');
            } else { opt.text = num; }
            selectUnidad.appendChild(opt);
        }
    }

    window.cargarOpcionesFalla = function() {
        const index = document.getElementById('selectorGrupo').value;
        const contenedor = document.getElementById('contenedorCheckboxes');
        const panel = document.getElementById('panelFallas');
        if (index === "") return;
        contenedor.innerHTML = ''; panel.style.display = 'block';
        configFlota[index].caps.forEach(cap => {
            let div = document.createElement('div');
            div.className = 'form-check form-switch';
            div.innerHTML = `<input class="form-check-input" type="checkbox" name="fallas" value="${cap}" id="chk_${cap}"><label class="form-check-label" for="chk_${cap}">${cap}</label>`;
            contenedor.appendChild(div);
        });
    }

    const selectGrupo = document.getElementById('selectorGrupo');
    configFlota.forEach((grupo, index) => {
        let opt = document.createElement('option'); opt.value = index; opt.text = grupo.label; selectGrupo.appendChild(opt);
    });

    // --- 4. ENVIAR DATOS ---
    document.getElementById('reporteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const unidad = document.getElementById('selectorUnidad').value;
        const obs = document.getElementById('observaciones').value;
        const checkboxes = document.querySelectorAll('input[name="fallas"]:checked');
        if (checkboxes.length === 0) { alert("Seleccione falla"); return; }
        let listaFallas = []; checkboxes.forEach(cb => listaFallas.push(cb.value));
        
        push(dbRef, {
            unidad: unidad, fallas: listaFallas, observaciones: obs,
            fecha: new Date().toLocaleDateString(), hora: new Date().toLocaleTimeString(),
            estado: "Pendiente", usuario: rolActual
        });
        
        document.getElementById('reporteForm').reset();
        document.getElementById('panelFallas').style.display = 'none';
        document.getElementById('selectorUnidad').disabled = true;
        document.getElementById('selectorUnidad').innerHTML = '<option value="">-- Primero elija grupo --</option>';
    });

    window.marcarCompletado = function(id) {
        if(confirm("¬øConfirmar reparaci√≥n completada?")) {
            update(ref(db, 'reparaciones/' + id), { estado: "Completado", fechaResolucion: new Date().toLocaleDateString() });
        }
    };
    window.eliminarReporte = function(id) {
        if(confirm("¬øEliminar este reporte permanentemente?")) { remove(ref(db, 'reparaciones/' + id)); }
    };

    // --- 5. FIREBASE LISTENERS (DENTRO DE FUNCI√ìN) ---
    function activarEscuchasFirebase() {
        // Limpiamos la tabla por si acaso
        document.getElementById('tablaCuerpo').innerHTML = "";
        
        // 1. Cargar datos existentes y escuchar nuevos
        onChildAdded(dbRef, (snapshot) => {
            document.getElementById('loading').style.display = 'none';
            crearFila(snapshot.key, snapshot.val());
        });

        // 2. Escuchar cambios (Ediciones)
        onChildChanged(dbRef, (snapshot) => {
            const filaVieja = document.getElementById(snapshot.key);
            if(filaVieja) filaVieja.remove();
            crearFila(snapshot.key, snapshot.val());
        });

        // 3. Escuchar borrados
        onChildRemoved(dbRef, (snapshot) => {
            const fila = document.getElementById(snapshot.key);
            if(fila) fila.remove();
        });
    }

    // --- 6. FUNCI√ìN DE DIBUJADO DE FILA ---
    function crearFila(key, data) {
        let badgesHtml = (data.fallas || []).map(f => {
            let color = 'bg-primary';
            if(f === 'GPS') color = 'bg-danger';
            if(f === 'RFID') color = 'bg-warning text-dark';
            if(f === 'NVR') color = 'bg-info text-dark';
            if(f === 'Censado') color = 'bg-success';
            return `<span class="badge ${color} badge-falla">${f}</span>`;
        }).join('');

        let estadoBadge = `<span class="badge bg-secondary">Pendiente</span>`;
        let claseFila = "";
        let botones = ""; 

        // Definir botones seg√∫n el ROL ACTUAL
        if (rolActual === 'T√©cnico' || rolActual === 'Supervisor') {
            if (data.estado !== "Completado") {
                botones += `<button onclick="marcarCompletado('${key}')" class="btn btn-sm btn-success me-1" title="Listo">‚úÖ</button>`;
            }
            if (rolActual === 'Supervisor') {
                botones += `<button onclick="eliminarReporte('${key}')" class="btn btn-sm btn-danger" title="Eliminar">üóëÔ∏è</button>`;
            }
        } else {
            botones = `<small class="text-muted">üëÅÔ∏è</small>`;
        }

        if (data.estado === "Completado") {
            estadoBadge = `<span class="badge bg-success">‚úÖ Listo</span>`;
            claseFila = "table-success"; 
        }

        const nuevaFila = `
            <tr id="${key}" class="${claseFila}">
                <td class="fw-bold">${data.unidad}</td>
                <td>${badgesHtml}</td>
                <td>${data.fecha} <br><small class="text-muted">${data.hora}</small></td>
                <td>${estadoBadge}</td>
                <td>${botones}</td>
            </tr>
        `;
        
        // Insertamos al inicio de la tabla
        document.getElementById('tablaCuerpo').insertAdjacentHTML('afterbegin', nuevaFila);
    }
</script>

</body>
</html>