<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GestiÃ³n de Flota</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d6efd">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Gestion Flota","short_name":"Flota","display":"standalone","start_url":".","background_color":"#ffffff","theme_color":"#0d6efd","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/741/741407.png","sizes":"512x512","type":"image/png"}]}'>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/741/741407.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš›</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --bg-light: #f4f6f9; }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* ESTILOS VISUALES */
        .fuera-servicio { background-color: #ffe6e6 !important; color: #dc3545; font-weight: bold; text-decoration: line-through; }
        .table-responsive { max-height: 600px; overflow-y: auto; border-radius: 10px; }
        .table thead th { position: sticky; top: 0; background-color: #343a40; color: white; z-index: 2; border: none; }
        tr { transition: transform 0.2s ease, background-color 0.2s; }
        
        /* LOGIN ANIMADO */
        #pantalla-login {
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
        .card-login { width: 100%; max-width: 420px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 20px; border:none; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }

        /* UI GENERAL */
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .navbar-custom { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 15px 0; margin-bottom: 30px; }
        
        #contenedorCheckboxes .form-check { 
            background-color: #fff; border: 1px solid #dee2e6; padding: 10px 15px 10px 40px; 
            border-radius: 50px; cursor: pointer; transition: all 0.2s; user-select: none;
        }
        #contenedorCheckboxes .form-check:hover { border-color: #0d6efd; background-color: #f8fbff; }
        .form-check-input:checked + .form-check-label { color: #0d6efd; font-weight: bold; }

        #tablaCuerpo:empty::before { content: "No hay reportes pendientes"; display: block; text-align: center; padding: 20px; color: #adb5bd; font-style: italic; width: 100%; }
        
        /* Ajuste para mÃ³vil */
        @media (max-width: 768px) {
            .btn-texto { display: none; }
        }
    </style>
</head>
<body>

<div id="pantalla-login">
    <div class="card card-login p-5">
        <div class="text-center mb-4">
            <h1 style="font-size: 4rem;">ðŸš›</h1>
            <h3 class="fw-bold text-dark">Control de Flota</h3>
            <p class="text-muted">Seleccione su perfil</p>
        </div>
        <div class="d-grid gap-3">
            <button onclick="intentarLogin('reportador')" class="btn btn-primary btn-lg shadow-sm"><i class="fas fa-file-invoice me-2"></i>Reportador</button>
            <button onclick="intentarLogin('tecnico')" class="btn btn-success btn-lg shadow-sm"><i class="fas fa-wrench me-2"></i>TÃ©cnico</button>
            <button onclick="intentarLogin('supervisor')" class="btn btn-dark btn-lg shadow-sm"><i class="fas fa-user-shield me-2"></i>Supervisor</button>
        </div>
    </div>
</div>

<div id="pantalla-app" style="display:none;">
    
    <nav class="navbar navbar-custom sticky-top">
        <div class="container">
            <div class="d-flex align-items-center">
                <span style="font-size: 1.5rem;" class="me-2">ðŸš›</span>
                <div>
                    <h5 class="m-0 fw-bold text-dark">GestiÃ³n de Flota</h5>
                    <span class="badge bg-light text-secondary border" id="badgeRolUsuario">Rol: --</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button id="btnStats" onclick="abrirEstadisticas()" class="btn btn-info text-white shadow-sm" style="display:none;" title="EstadÃ­sticas y Excel">
                    <i class="fas fa-chart-pie"></i> <span class="btn-texto">Reportes</span>
                </button>
                <button id="btnAdminFlota" onclick="abrirModalFlota()" class="btn btn-warning shadow-sm" style="display:none;" title="Gestionar Unidades">
                    <i class="fas fa-cogs"></i> <span class="btn-texto">Flota</span>
                </button>
                <button onclick="cerrarSesion()" class="btn btn-outline-danger shadow-sm" title="Salir">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="card">
            <div class="card-header bg-primary text-white bg-gradient d-flex justify-content-between align-items-center">
                <span><i class="fas fa-plus-circle me-2"></i>Nuevo Reporte</span>
            </div>
            <div class="card-body p-4">
                <form id="reporteForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">1. Grupo</label>
                            <select class="form-select form-select-lg" id="selectorGrupo" onchange="cargarUnidades('principal')" required>
                                <option value="">-- Seleccionar --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">2. Unidad</label>
                            <select class="form-select form-select-lg" id="selectorUnidad" onchange="cargarOpcionesFalla()" disabled required>
                                <option value="">-- Primero elija grupo --</option>
                            </select>
                            <div id="avisoBaja" class="alert alert-danger mt-2 py-2" style="display:none;">
                                <i class="fas fa-ban me-2"></i>Unidad dada de BAJA
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-light rounded-3 border" id="panelFallas" style="display:none;">
                        <label class="form-label fw-bold text-danger mb-3"><i class="fas fa-exclamation-circle me-2"></i>3. Marque las fallas:</label>
                        <div id="contenedorCheckboxes" class="d-flex flex-wrap gap-3"></div>
                    </div>
                    <div class="mt-3">
                        <textarea id="observaciones" class="form-control" rows="2" placeholder="Observaciones adicionales..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-lg w-100 mt-4 shadow-sm"><i class="fas fa-paper-plane me-2"></i>Enviar Reporte</button>
                </form>
            </div>
        </div>

        <div class="row mb-4 text-center g-3" id="tableroComando">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #ff9966, #ff5e62); color: white;">
                    <div class="card-body">
                        <h1 class="display-4 fw-bold mb-0" id="contadorPendientes">0</h1>
                        <p class="mb-0"><i class="fas fa-tools me-2"></i>En ReparaciÃ³n</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #56ab2f, #a8e063); color: white;">
                    <div class="card-body">
                        <h1 class="display-4 fw-bold mb-0" id="contadorListas">0</h1>
                        <p class="mb-0"><i class="fas fa-check-circle me-2"></i>Reparadas (Lista)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #4568dc, #b06ab3); color: white;">
                    <div class="card-body">
                        <h1 class="display-4 fw-bold mb-0" id="contadorBajas">0</h1>
                        <p class="mb-0"><i class="fas fa-ban me-2"></i>Unidades de Baja</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-dark text-white d-flex flex-wrap justify-content-between align-items-center py-3">
                <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Reparaciones Pendientes</h5>
                <div class="input-group input-group-sm mt-2 mt-md-0" style="max-width: 250px;">
                    <span class="input-group-text bg-secondary text-white border-0"><i class="fas fa-search"></i></span>
                    <input type="text" id="busquedaTabla" class="form-control border-0" placeholder="Buscar unidad...">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 text-center align-middle" id="tablaReportes">
                        <thead class="table-light">
                            <tr>
                                <th class="py-3">Unidad <i class="fas fa-sort text-muted ms-1" style="cursor:pointer;" onclick="ordenarTabla(0)"></i></th>
                                <th>Fallas</th>
                                <th>Fecha <i class="fas fa-sort text-muted ms-1" style="cursor:pointer;" onclick="ordenarTabla(2)"></i></th>
                                <th>Estado <i class="fas fa-sort text-muted ms-1" style="cursor:pointer;" onclick="ordenarTabla(3)"></i></th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCuerpo" class="bg-white"></tbody>
                    </table>
                </div>
                <div id="loading" class="text-center p-5 text-muted">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 small">Conectando...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastNotificacion" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fs-6"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalObservaciones" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white"><h5 class="modal-title">Observaciones</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-4 lead fs-6" id="modalContenido"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFlota" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold text-dark"><i class="fas fa-traffic-light me-2"></i>Gestionar Estado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted mb-4">Seleccione unidad para cambiar estado.</p>
                <div class="mb-3"><label class="fw-bold small text-secondary">Grupo</label><select class="form-select" id="adminSelectorGrupo" onchange="cargarUnidades('admin')"><option value="">-- Seleccionar --</option></select></div>
                <div class="mb-4"><label class="fw-bold small text-secondary">Unidad</label><select class="form-select" id="adminSelectorUnidad" onchange="verificarEstadoAdmin()"><option value="">-- Seleccionar --</option></select></div>
                <div id="panelAccionAdmin" class="text-center p-4 border rounded bg-light" style="display:none;">
                    <h5 id="lblEstadoActual" class="mb-3 fw-bold"></h5>
                    <button id="btnCambiarEstado" onclick="cambiarEstadoUnidad()" class="btn btn-lg w-100 shadow-sm"></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEstadisticas" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-chart-bar me-2"></i>EstadÃ­sticas y Reportes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted text-center mb-3">DistribuciÃ³n de Fallas</h6>
                                <canvas id="chartTipos"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted text-center mb-3">Top Unidades ProblemÃ¡ticas</h6>
                                <canvas id="chartUnidades"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid">
                    <button onclick="descargarExcel()" class="btn btn-success btn-lg shadow">
                        <i class="fas fa-file-excel me-2"></i>Descargar Historial Completo a Excel
                    </button>
                    <small class="text-muted text-center mt-2">El archivo incluye todos los reportes histÃ³ricos y sus estados.</small>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, update, remove, onChildAdded, onChildChanged, onChildRemoved, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDVeuhJt3jdlkGcLr0nvuJA4qZldZp0eXw",
        authDomain: "gestionflota-ea461.firebaseapp.com",
        databaseURL: "https://gestionflota-ea461-default-rtdb.firebaseio.com",
        projectId: "gestionflota-ea461",
        storageBucket: "gestionflota-ea461.firebasestorage.app",
        messagingSenderId: "43528636288",
        appId: "1:43528636288:web:c8a9f3f740bcfb7e856365"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'reparaciones');
    const dbFlotaRef = ref(db, 'estado_flota');

    let rolActual = ""; 
    let mapaBajas = {};
    let chartInstanceTipos = null;
    let chartInstanceUnidades = null;
    
    // --- NUEVO: CONFIGURACIÃ“N DE SONIDO ---
    const sonidoAlerta = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'); 
    let tiempoInicioSesion = new Date(); // Registramos cuÃ¡ndo abriÃ³ la app

    // --- LOGIN ---
    window.intentarLogin = function(rol) {
        let pass = null;
        if (rol === 'tecnico') {
            pass = prompt("Ingrese Clave de TÃ©cnico:");
            if (pass !== "1234") { mostrarToast('â›” Clave incorrecta', 'danger'); return; }
        } else if (rol === 'supervisor') {
            pass = prompt("Ingrese Clave de Supervisor:");
            if (pass !== "admin") { mostrarToast('â›” Clave incorrecta', 'danger'); return; }
        }
        let nombreRol = rol.charAt(0).toUpperCase() + rol.slice(1);
        if(rol === 'tecnico') nombreRol = 'TÃ©cnico'; // Ajuste tilde
        
        // Reiniciamos el tiempo para que empiecen a sonar las alertas desde AHORA
        tiempoInicioSesion = new Date(); 
        
        iniciarApp(nombreRol);
    };

    function iniciarApp(rolNombre) {
        rolActual = rolNombre;
        document.getElementById('pantalla-login').style.display = 'none';
        document.getElementById('pantalla-app').style.display = 'block';
        document.getElementById('badgeRolUsuario').innerText = rolActual;
        
        if(rolActual === 'Supervisor') {
            document.getElementById('btnAdminFlota').style.display = 'block';
            document.getElementById('btnStats').style.display = 'block';
        }
        activarEscuchasFirebase();
    }
    window.cerrarSesion = function() { location.reload(); };

    // --- CONFIG FLOTA ---
    const configFlota = [
        { label: "Serie 0100 (0104-0200)", min: 104, max: 200, caps: ["GPS"] },
        { label: "Serie 1000 A (1016-1081)", min: 1016, max: 1081, caps: ["GPS", "RFID", "Censado", "NVR"] },
        { label: "Serie 1100 (1121-1150)", min: 1121, max: 1150, caps: ["GPS", "NVR"] },
        { label: "Serie 1200 (1204-1235)", min: 1204, max: 1235, caps: ["GPS", "Censado"] },
        { label: "Serie 1300 (1304-1312)", min: 1304, max: 1312, caps: ["GPS"] },
        { label: "Serie 1400 (1407-1421)", min: 1407, max: 1421, caps: ["GPS"] },
        { label: "Serie 1600 (1604-1610)", min: 1604, max: 1610, caps: ["GPS", "RFID", "Censado"] },
        { label: "Serie 1700 (1704-1727)", min: 1704, max: 1727, caps: ["GPS", "Censado", "NVR"] },
        { label: "Serie 1900 (1902-1927)", min: 1902, max: 1927, caps: ["GPS", "NVR"] },
        { label: "Especial (1950)", min: 1950, max: 1950, caps: ["GPS"] }
    ];

    const selectGrupo = document.getElementById('selectorGrupo');
    const adminSelectGrupo = document.getElementById('adminSelectorGrupo');
    configFlota.forEach((grupo, index) => {
        let opt = new Option(grupo.label, index);
        selectGrupo.appendChild(opt);
        adminSelectGrupo.appendChild(opt.cloneNode(true));
    });

    // --- CARGA UNIDADES ---
    window.cargarUnidades = function(tipo) {
        const idSelectorGrupo = tipo === 'principal' ? 'selectorGrupo' : 'adminSelectorGrupo';
        const idSelectorUnidad = tipo === 'principal' ? 'selectorUnidad' : 'adminSelectorUnidad';
        const index = document.getElementById(idSelectorGrupo).value;
        const selectUnidad = document.getElementById(idSelectorUnidad);
        
        selectUnidad.innerHTML = '<option value="">-- Seleccionar --</option>';
        if(tipo === 'principal') {
            document.getElementById('panelFallas').style.display = 'none';
            document.getElementById('avisoBaja').style.display = 'none';
        } else {
            document.getElementById('panelAccionAdmin').style.display = 'none';
        }
        if (index === "") { selectUnidad.disabled = true; return; }
        
        const grupo = configFlota[index]; 
        selectUnidad.disabled = false;
        for (let i = grupo.min; i <= grupo.max; i++) {
            let opt = document.createElement('option');
            let num = i.toString().padStart(4, '0');
            opt.value = num;
            let estaDeBaja = mapaBajas[num] === true;
            if (tipo === 'principal') {
                if (estaDeBaja) {
                    opt.text = `${num} (FUERA DE SERVICIO)`; opt.disabled = true; opt.classList.add('fuera-servicio');
                } else { opt.text = num; }
            } else {
                if (estaDeBaja) {
                    opt.text = `${num} ðŸ”´ BAJA`; opt.style.color = 'red';
                } else { opt.text = `${num} ðŸŸ¢ OK`; }
            }
            selectUnidad.appendChild(opt);
        }
    }

    window.cargarOpcionesFalla = function() {
        const index = document.getElementById('selectorGrupo').value;
        const contenedor = document.getElementById('contenedorCheckboxes');
        const panel = document.getElementById('panelFallas');
        if (index === "") return;
        contenedor.innerHTML = ''; panel.style.display = 'block';
        configFlota[index].caps.forEach(cap => {
            let div = document.createElement('div');
            div.className = 'form-check form-switch';
            div.innerHTML = `<input class="form-check-input" type="checkbox" name="fallas" value="${cap}" id="chk_${cap}"><label class="form-check-label ps-2" for="chk_${cap}">${cap}</label>`;
            contenedor.appendChild(div);
        });
    }

    // --- GESTIÃ“N FLOTA ---
    window.abrirModalFlota = function() { new bootstrap.Modal(document.getElementById('modalFlota')).show(); };
    window.verificarEstadoAdmin = function() {
        const unidad = document.getElementById('adminSelectorUnidad').value;
        if(!unidad) { document.getElementById('panelAccionAdmin').style.display = 'none'; return; }
        document.getElementById('panelAccionAdmin').style.display = 'block';
        const lbl = document.getElementById('lblEstadoActual');
        const btn = document.getElementById('btnCambiarEstado');
        if(mapaBajas[unidad] === true) {
            lbl.innerHTML = `Unidad ${unidad}: <span class="text-danger">FUERA DE SERVICIO</span>`;
            btn.innerHTML = `<i class="fas fa-check-circle me-2"></i>REHABILITAR UNIDAD`; btn.className = "btn btn-success w-100 shadow";
            btn.onclick = function() { toggleBaja(unidad, false); };
        } else {
            lbl.innerHTML = `Unidad ${unidad}: <span class="text-success">OPERATIVA</span>`;
            btn.innerHTML = `<i class="fas fa-ban me-2"></i>DAR DE BAJA`; btn.className = "btn btn-danger w-100 shadow";
            btn.onclick = function() { toggleBaja(unidad, true); };
        }
    };
    function toggleBaja(unidad, darDeBaja) {
        const refUnidad = ref(db, `estado_flota/${unidad}`);
        if(darDeBaja) { set(refUnidad, true).then(() => mostrarToast(`Unidad ${unidad} dada de BAJA`, 'success')); }
        else { remove(refUnidad).then(() => mostrarToast(`Unidad ${unidad} REHABILITADA`, 'success')); }
        setTimeout(() => { cargarUnidades('admin'); document.getElementById('adminSelectorUnidad').value = unidad; verificarEstadoAdmin(); cargarUnidades('principal'); }, 500);
    }

    // --- ESTADÃSTICAS Y EXCEL ---
    window.abrirEstadisticas = function() {
        new bootstrap.Modal(document.getElementById('modalEstadisticas')).show();
        
        // Obtener datos para grÃ¡ficos
        get(dbRef).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                let conteoFallas = {};
                let conteoUnidades = {};

                Object.values(data).forEach(reporte => {
                    // Contar fallas
                    if (reporte.fallas) {
                        reporte.fallas.forEach(f => {
                            conteoFallas[f] = (conteoFallas[f] || 0) + 1;
                        });
                    }
                    // Contar unidad problemÃ¡tica
                    conteoUnidades[reporte.unidad] = (conteoUnidades[reporte.unidad] || 0) + 1;
                });

                // Renderizar grÃ¡ficos
                renderizarCharts(conteoFallas, conteoUnidades);
            }
        });
    };

    function renderizarCharts(fallas, unidades) {
        const ctxTipos = document.getElementById('chartTipos').getContext('2d');
        const ctxUnidades = document.getElementById('chartUnidades').getContext('2d');

        if(chartInstanceTipos) chartInstanceTipos.destroy();
        if(chartInstanceUnidades) chartInstanceUnidades.destroy();

        // 1. Chart Tipos (Pie)
        chartInstanceTipos = new Chart(ctxTipos, {
            type: 'doughnut',
            data: {
                labels: Object.keys(fallas),
                datasets: [{
                    data: Object.values(fallas),
                    backgroundColor: ['#dc3545', '#ffc107', '#0dcaf0', '#198754'],
                    borderWidth: 0
                }]
            }
        });

        // 2. Chart Unidades (Bar) - Top 5
        const topUnidades = Object.entries(unidades)
            .sort(([,a],[,b]) => b-a)
            .slice(0, 5);

        chartInstanceUnidades = new Chart(ctxUnidades, {
            type: 'bar',
            data: {
                labels: topUnidades.map(u => u[0]),
                datasets: [{
                    label: 'Reportes',
                    data: topUnidades.map(u => u[1]),
                    backgroundColor: '#0d6efd',
                    borderRadius: 5
                }]
            },
            options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
        });
    }

    window.descargarExcel = function() {
        get(dbRef).then((snapshot) => {
            if (snapshot.exists()) {
                const rawData = snapshot.val();
                const dataParaExcel = Object.keys(rawData).map(key => {
                    const r = rawData[key];
                    return {
                        Unidad: r.unidad,
                        Fallas: Array.isArray(r.fallas) ? r.fallas.join(", ") : r.fallas,
                        Fecha: r.fecha,
                        Hora: r.hora,
                        Estado: r.estado,
                        Usuario: r.usuario || "Desconocido",
                        Observaciones: r.observaciones || ""
                    };
                });
                const ws = XLSX.utils.json_to_sheet(dataParaExcel);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reportes");
                XLSX.writeFile(wb, "Reportes_Flota_" + new Date().toISOString().slice(0,10) + ".xlsx");
            } else {
                mostrarToast("No hay datos para exportar", "warning");
            }
        });
    };

    // --- FORM SUBMIT ---
    document.getElementById('reporteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const unidad = document.getElementById('selectorUnidad').value;
        const obs = document.getElementById('observaciones').value.trim();
        const checkboxes = document.querySelectorAll('input[name="fallas"]:checked');
        if (!unidad || checkboxes.length === 0) { mostrarToast('âš ï¸ Faltan datos', 'danger'); return; }
        let listaFallas = Array.from(checkboxes).map(cb => cb.value);
        push(dbRef, {
            unidad: unidad, fallas: listaFallas, observaciones: obs,
            fecha: new Date().toLocaleDateString('es-AR'), hora: new Date().toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'}),
            estado: "Pendiente", usuario: rolActual
        }).then(() => {
            mostrarToast('âœ… Reporte enviado.', 'success'); document.getElementById('reporteForm').reset();
            document.getElementById('panelFallas').style.display = 'none'; document.getElementById('selectorUnidad').disabled = true;
            document.getElementById('selectorUnidad').innerHTML = '<option value="">-- Primero elija grupo --</option>';
        });
    });

    // --- ACCIONES TABLA ---
    window.marcarCompletado = function(id) { 
        if(confirm("Â¿Confirmar reparaciÃ³n completada?")) {
            update(ref(db, 'reparaciones/' + id), { estado: "Completado", fechaResolucion: new Date().toLocaleDateString('es-AR') })
            .then(() => mostrarToast('ðŸ‘ ReparaciÃ³n completada.', 'success'));
        }
    };
    window.eliminarReporte = function(id) { 
        if(confirm("Â¿Eliminar este reporte?")) {
            remove(ref(db, 'reparaciones/' + id)).then(() => mostrarToast('ðŸ—‘ï¸ Reporte eliminado.', 'success'));
        }
    };
    window.mostrarObservaciones = function(obs) {
        document.getElementById('modalContenido').innerText = obs || 'Sin observaciones.';
        new bootstrap.Modal(document.getElementById('modalObservaciones')).show();
    };

    // --- LÃ“GICA DASHBOARD ---
    function actualizarTablero() {
        const filas = document.querySelectorAll('#tablaCuerpo tr');
        let pendientes = 0;
        let listas = 0;
        filas.forEach(fila => {
            if (fila.classList.contains('table-success')) { listas++; } else { pendientes++; }
        });
        document.getElementById('contadorPendientes').innerText = pendientes;
        document.getElementById('contadorListas').innerText = listas;
        const totalBajas = Object.keys(mapaBajas).length;
        document.getElementById('contadorBajas').innerText = totalBajas;
    }

    // --- ESCUCHAS FIREBASE ---
    function activarEscuchasFirebase() {
        document.getElementById('tablaCuerpo').innerHTML = "";
        
        onValue(dbFlotaRef, (snapshot) => { 
            mapaBajas = snapshot.val() || {}; 
            if(document.getElementById('selectorGrupo').value !== "") cargarUnidades('principal'); 
            actualizarTablero(); 
        });

        onChildAdded(dbRef, (snap) => { 
            document.getElementById('loading').style.display='none'; 
            
            // --- NUEVA LÃ“GICA DE SONIDO ---
            // Solo suena si el reporte es NUEVO (se creÃ³ despuÃ©s de iniciar sesiÃ³n)
            // Y si no estÃ¡ completado
            const data = snap.val();
            
            if (data.fecha && data.hora) {
                // Parseamos la fecha del reporte "dd/mm/yyyy" y hora "HH:mm"
                const [dia, mes, anio] = data.fecha.split('/');
                const [horas, minutos] = data.hora.split(':');
                const fechaReporte = new Date(anio, mes - 1, dia, horas, minutos);
                
                // Si la fecha del reporte es MAYOR a la hora de login, suena
                if (fechaReporte > tiempoInicioSesion && data.estado !== 'Completado') {
                    sonidoAlerta.play().catch(e => console.log("Sonido bloqueado por navegador", e));
                    mostrarToast("ðŸ”” Â¡Nuevo ingreso de reparaciÃ³n!", "warning");
                }
            }

            crearFila(snap.key, data); 
            actualizarTablero(); 
        });
        
        onChildChanged(dbRef, (snap) => { 
            let f = document.getElementById(snap.key); 
            if(f) f.remove(); 
            crearFila(snap.key, snap.val()); 
            actualizarTablero(); 
        });
        
        onChildRemoved(dbRef, (snap) => { 
            let f = document.getElementById(snap.key); 
            if(f) f.remove(); 
            actualizarTablero(); 
        });
    }

    function crearFila(key, data) {
        let badges = (data.fallas||[]).map(f => `<span class="badge rounded-pill ${f==='GPS'?'bg-danger':f==='RFID'?'bg-warning text-dark':f==='NVR'?'bg-info text-dark':'bg-success'} badge-falla border border-light shadow-sm">${f}</span>`).join('');
        let acciones = `<button onclick="mostrarObservaciones('${(data.observaciones||'').replace(/'/g, "\\'")}')" class="btn btn-sm btn-outline-info me-1 border-0"><i class="fas fa-eye"></i></button>`;
        
        if (rolActual === 'TÃ©cnico' || rolActual === 'Supervisor') {
            if (data.estado !== "Completado") acciones += `<button onclick="marcarCompletado('${key}')" class="btn btn-sm btn-outline-success me-1" title="Listo"><i class="fas fa-check"></i></button>`;
            if (rolActual === 'Supervisor') acciones += `<button onclick="eliminarReporte('${key}')" class="btn btn-sm btn-outline-danger" title="Eliminar"><i class="fas fa-trash-alt"></i></button>`;
        }
        
        const html = `<tr id="${key}" class="${data.estado === "Completado" ? "table-success bg-opacity-25" : ""}">
            <td class="fw-bold text-dark">${data.unidad}</td><td>${badges}</td><td>${data.fecha}<br><small class="text-muted">${data.hora}</small></td>
            <td>${data.estado === "Completado" ? '<span class="badge rounded-pill bg-success">Listo</span>' : '<span class="badge rounded-pill bg-secondary">Pendiente</span>'}</td>
            <td>${acciones}</td></tr>`;
        document.getElementById('tablaCuerpo').insertAdjacentHTML('afterbegin', html);
    }
    
    // UI Helpers
    document.getElementById('busquedaTabla').addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('#tablaCuerpo tr').forEach(row => row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none');
    });
    let ordenAsc = true;
    window.ordenarTabla = function(colIndex) {
        const table = document.getElementById('tablaReportes');
        const rows = Array.from(table.tBodies[0].rows);
        rows.sort((a, b) => ordenAsc ? a.cells[colIndex].textContent.localeCompare(b.cells[colIndex].textContent) : b.cells[colIndex].textContent.localeCompare(a.cells[colIndex].textContent));
        ordenAsc = !ordenAsc; rows.forEach(row => table.tBodies[0].appendChild(row));
    };
    function mostrarToast(mensaje, tipo='info') {
        const t = document.getElementById('toastNotificacion'); t.querySelector('.toast-body').innerHTML = mensaje;
        t.className = `toast align-items-center text-white border-0 text-bg-${tipo}`; new bootstrap.Toast(t).show();
    }
</script>
</body>
</html>
